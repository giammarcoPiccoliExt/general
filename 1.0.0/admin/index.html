<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Editor Markdown con GitHub</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/editor.md@1.5.0/css/editormd.min.css" />
<link rel="stylesheet" href="../personalization/eng-standard-theme-editor.css" />

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/editor.md@1.5.0/editormd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/editor.md@1.5.0/languages/en.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    #editor { width: 90%; margin: auto; display: none; }
    #file-list { width: 90%; margin: 20px auto; display: none; }
    #configurator { width: 400px; margin: 50px auto; border: 1px solid #ccc; padding: 20px; border-radius: 8px; }
    #configurator input { width: 100%; margin-bottom: 10px; padding: 8px; }
    #configurator button { padding: 10px 20px; }
    #sidebar {
    position: fixed;
    left: 0;
    top: 0;
    width: 280px;
    height: 100vh;
    background: #162538;
    color: #fff;
    border-right: 1px solid #444;
    padding: 20px 10px 10px 10px;
    transition: left 0.3s;
    z-index: 100;
  }
  #sidebar.collapsed {
    left: -250px;
  }
  #sidebar-toggle {
    position: fixed;
    left: 0;
    top: 10px;
    background: #ffab66;
    color: #162538;
    border: none;
    border-radius: 0 8px 8px 0;
    padding: 8px 12px;
    cursor: pointer;
    z-index: 101;
  }
  #sidebar h3 { color: #ffab66; }
  #sidebar button { width: 100%; margin-bottom: 10px; }
  #sidebar input[type="file"] { margin-bottom: 10px; }
  #editor { margin-left: 280px; }
  #sidebar.collapsed ~ #editor { margin-left: 0; }
  </style>
</head>
<body>

<div id="configurator">
  <h3>Configura Editor Markdown</h3>
  <input type="text" id="username" placeholder="GitHub Username" />
  <input type="text" id="repo" placeholder="Repository Name" />
  <input type="password" id="token" placeholder="Personal Access Token" />
  <button id="startBtn">Avvia Editor</button>
</div>
<button id="sidebar-toggle">â˜°</button>
<div id="sidebar">
  <h3>File disponibili:</h3>
  <ul id="file-list-ul"></ul>
  <button id="saveBtn" style="margin-top:10px;">Salva Modifiche</button>
  <button id="deployBtn" style="margin-top:10px;">Esegui Deploy Docs</button>
  <input type="file" id="uploadImage" accept="image/*" style="margin-top:10px;" />
  <button id="uploadBtn" style="margin-top:10px;">Carica Immagine</button>
</div>

<div id="editor" class="wising-section">
  <textarea style="display:none;"># Benvenuto nel tuo editor Markdown</textarea>
</div>



<script>
let editor;
let currentFilePath = null;
let currentUsername = null;
let currentRepo = null;
let currentToken = null;
let currentSha = null;
let branch = 'main';
let currentFileContent = null; // Store original markdown

function initEditor() {
  editor = editormd("editor", {
    width: "100%",
    height: 640,
    path: "https://cdn.jsdelivr.net/npm/editor.md@1.5.0/lib/",
    toolbar: true,
    imageUpload: false, // se non vuoi upload
    htmlDecode: true,
    setMarkdown: "# Benvenuto nel tuo editor Markdown",
    onload: function() {
        // Sostituire i src delle immagini renderizzate
        const baseUrl = `https://raw.githubusercontent.com/${currentUsername}/${currentRepo}/${branch}/documentation/docs/`;
        $('#editor img').each(function() {
            const src = $(this).attr('src');
            if (src && src.startsWith('images/')) {
                $(this).attr('src', baseUrl + src);
            }
        });
    }
  });
}
// Decodifica Base64 in UTF-8 correttamente
function decodeBase64Utf8(base64Str) {
    // atob restituisce ASCII, quindi convertiamo in UTF-8
    const binaryStr = atob(base64Str.replace(/\s/g, ''));
    const bytes = Uint8Array.from(binaryStr, c => c.charCodeAt(0));
    const decoder = new TextDecoder('utf-8');
    return decoder.decode(bytes);
}

function loadFiles(username, repo, token) {
    console.log("Tentativo di caricare file dalla repo:", repo);

    $('#file-list-ul').empty();

    // Funzione ricorsiva per esplorare le cartelle
function fetchFolder(path = '') {
    const url = `https://api.github.com/repos/${username}/${repo}/contents/${path}`;
    $.ajax({
        url: url,
        headers: { 'Authorization': `token ${token}` },
        success: function(files) {
            files.forEach(file => {
                if(file.type === 'dir') {
                    if(file.name === 'documentation' || path.startsWith('documentation/')) {
                        fetchFolder(file.path);
                    }
                } else if(file.type === 'file' && file.name.endsWith('.md') && path.startsWith('documentation/')) {
                    $('#file-list-ul').append(
                        `<li><a href="#" onclick="loadFile('${file.path}','${username}','${repo}','${token}')">${file.path}</a></li>`
                    );
                }
            });
        },
        error: function(err) {
            console.error(err);
        }
    });
}

    // Avvio dal root della repo
    fetchFolder('');
}


function loadFile(path, username, repo, token, branch ='main') {
    const url = `https://api.github.com/repos/${username}/${repo}/contents/${path}?ref=${branch}`;
    $.ajax({
        url: url,
        headers: { 'Authorization': `token ${token}` },
        success: function(file) {
            if (file && file.content) {
                // Decodifica UTF-8
                let content = decodeBase64Utf8(file.content);
                currentFileContent = content; // Save original markdown

                // Impostiamo il contenuto nell'editor (sezione edit)
                editor.setMarkdown(content);
                $('#editor').show();

                // Preview: patch solo per la visualizzazione
                setTimeout(function() {
                    const baseUrl = `https://raw.githubusercontent.com/${username}/${repo}/${branch}/documentation/docs/`;
                    // Sostituisci src delle immagini nella preview
                    $('.editormd-preview-container img').each(function() {
                        const src = $(this).attr('src');
                        if (src && src.startsWith('images/')) {
                            $(this).attr('src', baseUrl + src);
                        }
                    });
                }, 500);

                // Aggiorna variabili globali per eventuale salvataggio
                currentFilePath = path;
                currentUsername = username;
                currentRepo = repo;
                currentToken = token;
                currentSha = file.sha;

                console.log("File caricato correttamente:", path);
            }
        },
        error: function(err) {
            console.error("Errore nel caricamento del file:", err);
            alert('Errore nel caricamento del file. Controlla console.');
        }
    });
}

// Salva il file modificato su GitHub
$('#saveBtn').on('click', function() {
    if (!currentFilePath || !currentUsername || !currentRepo || !currentToken) {
        alert('Nessun file selezionato o credenziali mancanti.');
        return;
    }
    // Get the current markdown from the editor
    let content = editor.getMarkdown();
    // Inverse patch: convert GitHub image URLs back to relative paths
    content = content.replace(/!\[(.*?)\]\(https:\/\/raw\.githubusercontent\.com\/[^\/]+\/[^\/]+\/[^\/]+\/documentation\/docs\/images\/([^\)]+)\)/g, '![$1](images/$2)');
    const base64Content = btoa(unescape(encodeURIComponent(content)));
    const url = `https://api.github.com/repos/${currentUsername}/${currentRepo}/contents/${currentFilePath}`;
    $.ajax({
        url: url,
        type: 'PUT',
        headers: { 'Authorization': `token ${currentToken}` },
        data: JSON.stringify({
            message: 'Aggiornamento file da editor web',
            content: base64Content,
            sha: currentSha
        }),
        success: function(res) {
            alert('File salvato con successo su GitHub!');
            currentSha = res.content.sha;
        },
        error: function(err) {
            console.error('Errore nel salvataggio:', err);
            alert('Errore nel salvataggio del file. Controlla console.');
        }
    });
});

function editAutomationYamlAndPush(username, repo, token, setTrue, callback) {
    const filePath = '.github/workflows/Automation.yml';
    const url = `https://api.github.com/repos/${username}/${repo}/contents/${filePath}`;
    $.ajax({
        url: url,
        headers: { 'Authorization': `token ${token}` },
        success: function(file) {
            let content = decodeBase64Utf8(file.content);
            // Modifica la variabile RUN_DEPLOY_DOCS
            content = content.replace(/RUN_DEPLOY_DOCS: 'true'|RUN_DEPLOY_DOCS: 'false'/, `RUN_DEPLOY_DOCS: '${setTrue ? 'true' : 'false'}'`);
            const base64Content = btoa(unescape(encodeURIComponent(content)));
            $.ajax({
                url: url,
                type: 'PUT',
                headers: { 'Authorization': `token ${token}` },
                data: JSON.stringify({
                    message: setTrue ? 'Abilita deploy docs' : 'Disabilita deploy docs',
                    content: base64Content,
                    sha: file.sha
                }),
                success: function(res) {
                    if (callback) callback(res.content.sha);
                },
                error: function(err) {
                    alert('Errore nel salvataggio di Automation.yml.');
                    console.error(err);
                }
            });
        },
        error: function(err) {
            alert('Errore nel caricamento di Automation.yml.');
            console.error(err);
        }
    });
}

$('#deployBtn').on('click', function() {
    if (!currentUsername || !currentRepo || !currentToken) {
        alert('Credenziali mancanti.');
        return;
    }
    // Step 1: set true and push
    editAutomationYamlAndPush(currentUsername, currentRepo, currentToken, true, function(shaTrue) {
        alert('Deploy abilitato e pushato! Attendi qualche secondo...');
        // Step 2: set false and push again after short delay
        setTimeout(function() {
            editAutomationYamlAndPush(currentUsername, currentRepo, currentToken, false, function(shaFalse) {
                alert('Deploy disabilitato e pushato!');
            });
        }, 5000); // 5 secondi di attesa
    });
});

// Gestore del click sul bottone di avvio
$('#startBtn').on('click', function() {
  const username = $('#username').val();
  const repo = $('#repo').val();
  const token = $('#token').val();
  currentUsername = username;
    currentRepo = repo; 
    currentToken = token;
    

  if (!username || !repo || !token) {
    alert('Compila tutti i campi!');
    return;
  }

  $('#configurator').hide();
  $('#editor').show();
  $('#file-list').show();

  initEditor();
  loadFiles(username, repo, token);
});

$('#sidebar-toggle').on('click', function() {
  $('#sidebar').toggleClass('collapsed');
});

$('#uploadBtn').on('click', function() {
    const fileInput = document.getElementById('uploadImage');
    const file = fileInput.files[0];
    if (!file) {
        alert('Seleziona un file immagine da caricare.');
        return;
    }
    if (!currentUsername || !currentRepo || !currentToken) {
        alert('Credenziali mancanti.');
        return;
    }
    const reader = new FileReader();
    reader.onload = function(e) {
        const base64Data = e.target.result.split(',')[1];
        const filePath = `documentation/docs/images/media/${file.name}`;
        const url = `https://api.github.com/repos/${currentUsername}/${currentRepo}/contents/${filePath}`;
        $.ajax({
            url: url,
            type: 'PUT',
            headers: { 'Authorization': `token ${currentToken}` },
            data: JSON.stringify({
                message: 'Aggiunta immagine da editor web',
                content: base64Data
            }),
            success: function(res) {
                alert('Immagine caricata con successo!');
                fileInput.value = '';
            },
            error: function(err) {
                console.error('Errore nel caricamento immagine:', err);
                alert('Errore nel caricamento dell\'immagine. Controlla console.');
            }
        });
    };
    reader.readAsDataURL(file);
});
</script>
</body>
</html>